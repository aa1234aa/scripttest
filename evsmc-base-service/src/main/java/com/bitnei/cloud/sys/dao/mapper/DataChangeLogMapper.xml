<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitnei.cloud.sys.dao.DataChangeLogMapper">
    <resultMap id="tailResults" type="com.bitnei.cloud.sys.domain.DataChangeLog" autoMapping="true">
        <association property="tails" javaType="java.util.HashMap">
        </association>
    </resultMap>

    <!-- 权限sql -->
    <sql id="authSQL">
        and ${authSQL}
    </sql>

    <!-- 通用查询结果列 -->
    <sql id="baseColumns">
        dlog.id  ,dlog.module_name ,dlog.inst_name ,dlog.type ,dlog.operator ,dlog.oper_time ,dlog.change_reason ,dlog.change_content ,dlog.orgin_content
    </sql>
    <sql id="moreColumns">
        dlog.id  ,dlog.module_name ,dlog.inst_name ,dlog.type ,dlog.operator ,dlog.oper_time ,dlog.change_reason ,dlog.change_content ,dlog.orgin_content
    </sql>

    <!-- 根据id查询 -->
    <select id="findById" resultType="com.bitnei.cloud.sys.domain.DataChangeLog"  parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_data_change_log dlog
        <where>
            dlog.id=#{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </select>

    <!-- 增加 -->
    <insert id="insert" parameterType="java.util.HashMap">
        insert into
        sys_data_change_log (id,module_name,inst_name,type,operator,oper_time,change_reason,change_content,orgin_content)
        values
        (#{id},#{moduleName},#{instName},#{type},#{operator},#{operTime},#{changeReason},#{changeContent},#{orginContent})
    </insert>

    <!-- 更新 -->
    <update id="update" parameterType="java.util.HashMap">
        update sys_data_change_log set
        id=id,module_name=#{moduleName},inst_name=#{instName},type=#{type},operator=#{operator},oper_time=#{operTime},change_reason=#{changeReason},change_content=#{changeContent},orgin_content=#{orginContent}
        <where>
            id = #{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>

    </update>

    <!-- 删除 -->
    <delete id="delete"  parameterType="java.util.HashMap">
        delete from
        sys_data_change_log
        <where>
            id = #{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </delete>

    <!-- 分页查询 -->
    <select id="pagerModel" resultMap="tailResults" parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_data_change_log dlog
        <where>
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
            <if test="moduleName != null">
                and dlog.module_name like "%"#{moduleName}"%"
            </if>
            <if test="instName != null">
                and dlog.inst_name LIKE CONCAT('%',#{instName},'%')
            </if>
            <if test="type != null">
                and dlog.type = #{type}
            </if>
            <if test="operator != null">
                and dlog.operator like "%"#{operator}"%"
            </if>

            <if test="beginTime != null">
                and dlog.oper_time <![CDATA[ >= ]]> #{beginTime}
            </if>
            <if test="endTime != null">
                and dlog.oper_time <![CDATA[ <= ]]> #{endTime}
            </if>
        </where>
        order by dlog.oper_time desc
    </select>
    
    <select id="findTable" resultType="com.bitnei.cloud.sys.domain.Table" parameterType="java.util.HashMap">
        SELECT  TABLE_NAME, TABLE_COMMENT FROM information_schema.`TABLES`
        WHERE TABLE_SCHEMA = 'evsmc2'
        AND TABLE_NAME IN
        <foreach collection="tableNames" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="findTableColumns" resultType="com.bitnei.cloud.sys.domain.Table" parameterType="java.util.HashMap">
        SELECT COLUMN_NAME, COLUMN_KEY, COLUMN_COMMENT
        FROM information_schema.`COLUMNS`
        WHERE TABLE_SCHEMA = 'evsmc2' AND TABLE_NAME = #{tableName}
    </select>


</mapper>
