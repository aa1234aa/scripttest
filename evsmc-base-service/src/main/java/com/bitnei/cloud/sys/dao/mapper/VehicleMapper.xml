<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitnei.cloud.sys.dao.VehicleMapper">

    <resultMap id="tailResults" type="com.bitnei.cloud.sys.domain.Vehicle" autoMapping="true">
        <association property="tails" javaType="java.util.HashMap">
            <result property="vehNoticeYear" column="veh_notice_year" />
            <result property="recommendYear" column="recommend_year" />
        </association>
    </resultMap>

    <!-- 权限sql -->
    <sql id="authSQL">
        and ${authSQL}
    </sql>

    <!-- 通用查询结果列 -->
    <sql id="baseColumns">
    v.id  ,v.vin ,v.uuid ,v.license_type ,v.license_plate ,v.inter_no ,v.veh_model_id ,v.color ,v.color_nick_name ,v.term_id ,v.stage ,v.stage_change_date ,v.manu_unit_id ,v.produce_batch ,v.quality_years ,v.veh_certificate_number ,v.produce_date ,v.factory_date ,v.sell_date ,v.sell_price ,v.sell_for_field ,v.sell_pri_veh_owner_id ,v.sell_pub_unit_id ,v.sell_city_id ,v.sell_4s_unit_id ,v.sell_seller_id ,v.sell_secure_date ,v.sell_first_check_date ,v.sell_invoice_no ,v.sell_invoice_date ,v.sell_invoice_img_id ,v.sell_license_no ,v.sell_license_reg_date ,v.sell_license_grant_date ,v.sell_license_img_id ,v.is_selled ,v.oper_inter_no ,v.oper_use_for ,v.oper_use_type ,v.oper_veh_owner_id ,v.oper_unit_id ,v.oper_license_city_id ,v.oper_area_id ,v.oper_time ,v.oper_support_owner_id ,v.oper_save_city_id ,v.oper_save_address ,v.oper_chg_city_id ,v.oper_chg_address ,v.is_opered ,v.subsidy_apply_status ,v.susidy_apply_count ,v.create_time ,v.create_by ,v.update_time ,v.update_by,license_plate_color,secondary_mtc_status,secondary_mtc_time,forced_scrap_date,initial_registration_date,annual_inspection_status,annual_inspection_date,annual_inspection_period,maintenance_period,oper_license_time
    </sql>
    <sql id="moreColumns">
    v.id  ,v.vin ,v.uuid ,v.license_type ,v.license_plate ,v.inter_no ,v.veh_model_id ,v.color ,v.color_nick_name ,v.term_id ,v.stage ,v.stage_change_date ,v.manu_unit_id ,v.produce_batch ,v.quality_years ,v.veh_certificate_number ,v.produce_date ,v.factory_date ,v.sell_date ,v.sell_price ,v.sell_for_field ,v.sell_pri_veh_owner_id ,v.sell_pub_unit_id ,v.sell_city_id ,v.sell_4s_unit_id ,v.sell_seller_id ,v.sell_secure_date ,v.sell_first_check_date ,v.sell_invoice_no ,v.sell_invoice_date ,v.sell_invoice_img_id ,v.sell_license_no ,v.sell_license_reg_date ,v.sell_license_grant_date ,v.sell_license_img_id ,v.is_selled ,v.oper_inter_no ,v.oper_use_for ,v.oper_use_type ,v.oper_veh_owner_id ,v.oper_unit_id ,v.oper_license_city_id ,v.oper_area_id ,v.oper_time ,v.oper_support_owner_id ,v.oper_save_city_id ,v.oper_save_address ,v.oper_chg_city_id ,v.oper_chg_address ,v.is_opered ,v.subsidy_apply_status ,v.susidy_apply_count ,v.create_time ,v.create_by ,v.update_time ,v.update_by,license_plate_color,secondary_mtc_status,secondary_mtc_time,forced_scrap_date,initial_registration_date,annual_inspection_status,annual_inspection_date,annual_inspection_period,maintenance_period,oper_license_time
    </sql>

    <!-- 根据id查询 -->
    <select id="findById" resultMap="tailResults"  parameterType="java.util.HashMap">
        select
            stmu.support_protocol supportProtocol,
          svm.veh_model_name AS veh_model_name,
          svt.name AS veh_type_name, svt.`name` AS veh_type_name, svt.`id` AS veh_type_id,
          svn.name AS veh_notice_name, svn.notice_year as veh_notice_year, svn.notice_batch as veh_notice_batch, svn.recommend_year, svn.recommend_batch,
          svm.rule_id , rule_type.name as rule_type_name, svm.config_name,
          svo.owner_name AS owner_name, svo.address AS owner_address,
          su.`name` AS sell_pub_unit_name, su.address AS sell_pub_unit_address,
          sa.`name` AS sell_city_name,
          sop.owner_name AS oper_support_owner_name, sop.tel_phone AS oper_support_owner_phone,
          area.`name` AS oper_save_city_name,
          chg_area.`name` AS oper_chg_city_name,
          svow.owner_name AS oper_owner_name, svow.tel_phone AS oper_tel_phone,
          sut.`name` AS oper_unit_name,  sut.contactor_name AS oper_contactor_name, sut.contactor_phone AS oper_contactor_phone,
          saa.`name` AS oper_area_name,
          vrs.online_status as historyOnlineState, svm.power_mode AS powerMode,
          rt.name termRuleTypeName,
          rt.code termRuleTypeCode,
          <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        left join sys_veh_type svt on svt.id = svn.veh_type_id
        left join dc_rule_type rule_type on rule_type.id = svm.rule_id
        LEFT JOIN sys_veh_owner svo ON svo.id = v.sell_pri_veh_owner_id
        LEFT JOIN sys_unit su ON su.id = v.sell_pub_unit_id
        LEFT JOIN sys_area sa ON sa.id = v.sell_city_id
        LEFT JOIN sys_owner_people sop ON sop.id = v.oper_support_owner_id
        LEFT JOIN sys_area area ON area.id = v.oper_save_city_id
        LEFT JOIN sys_area chg_area ON chg_area.id = v.oper_chg_city_id
        LEFT JOIN sys_veh_owner svow ON svow.id = v.oper_veh_owner_id
        LEFT JOIN sys_unit sut ON sut.id = v.oper_unit_id
        LEFT JOIN sys_area saa ON saa.id = v.oper_area_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        left join dc_rule ru on ru.id = stmu.support_protocol
        left join dc_rule_type rt on ru.rule_type_id = rt.id
        <where>
            v.id=#{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </select>

    <!-- 唯一验证不加权限码 -->
    <select id="uniqueFindByVin" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        v.id,v.vin,v.uuid
        from sys_vehicle v
        <where>
            v.vin=#{vin} and v.is_delete = 0
        </where>
    </select>

     <!-- 根据车架号查询 -->
    <select id="findByVin" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        svn.veh_type_id as vehTypeId,
        vrs.onlined as onlined,
        stmu.iccid,
        stmu.support_protocol supportProtocol,
        v.veh_model_id AS vehModelId,
        svm.veh_model_name AS vehModelName,
        rt.name termRuleTypeName,
        rt.code termRuleTypeCode,
        <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        left join dc_rule ru on ru.id = stmu.support_protocol
        left join dc_rule_type rt on ru.rule_type_id = rt.id
        <where>
            v.vin=#{vin} and v.is_delete = 0
        </where>
    </select>
    <select id="findByVinValidateAuth" resultType="com.bitnei.cloud.sys.domain.Vehicle"
            parameterType="java.util.HashMap">
        select
        svn.veh_type_id as vehTypeId,
        vrs.onlined as onlined,
        stmu.iccid,
        stmu.support_protocol supportProtocol,
        v.veh_model_id AS vehModelId,
        svm.veh_model_name AS vehModelName,
        rt.name termRuleTypeName,
        rt.code termRuleTypeCode,
        <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        left join dc_rule ru on ru.id = stmu.support_protocol
        left join dc_rule_type rt on ru.rule_type_id = rt.id
        <where>
            v.vin=#{vin} and v.is_delete = 0
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </select>

    <select id="findByVins" resultMap="tailResults"  parameterType="java.util.HashMap">
        select
        svn.veh_type_id as vehTypeId,
        vrs.onlined as onlined,
        stmu.iccid,
        stmu.support_protocol supportProtocol,
        svm.veh_model_name AS vehModelName,
        rt.name termRuleTypeName,
        rt.code termRuleTypeCode,
        <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        left join dc_rule ru on ru.id = stmu.support_protocol
        left join dc_rule_type rt on ru.rule_type_id = rt.id
        <where>
            v.is_delete = 0 and
            v.vin IN
            <foreach collection="vins" item="vin" open="(" separator="," close=")">
                #{vin}
            </foreach>
        </where>
    </select>

    <!-- 根据车id查询 -->
    <select id="findByIdSimple" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        svn.veh_type_id as vehTypeId,
        vrs.onlined as onlined,
        stmu.iccid,
        stmu.support_protocol supportProtocol,
        svm.veh_model_name AS vehModelName,
        <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        <where>
            v.id=#{id} and v.is_delete = 0
        </where>
    </select>
    <!-- 根据系统内部编码查询 -->
    <select id="findByUuid" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        stmu.support_protocol supportProtocol, svm.rule_id ruleId, rt.name ruleTypeName,
        rt.name termRuleTypeName,
        rt.code termRuleTypeCode,
        <include refid="moreColumns"/>
        from  sys_vehicle v
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        LEFT JOIN sys_veh_model svm ON svm.id = v.veh_model_id
        left join dc_rule ru on ru.id = stmu.support_protocol
        left join dc_rule_type rt on ru.rule_type_id = rt.id
        <where>
            v.uuid=#{uuid} and v.is_delete = 0
        </where>
    </select>

    <!-- 根据车牌号查询 -->
    <select id="findByLicensePlate" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        stmu.support_protocol supportProtocol,
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        <where>
            v.license_plate=#{licensePlate} and v.is_delete = 0
        </where>
    </select>

    <!-- 根据licensePlate计算 -->
    <select id="findByLicensePlateCount" resultType="java.lang.Integer">
        SELECT COUNT(v.id) FROM sys_vehicle v
        WHERE v.license_plate=#{licensePlate} and v.is_delete = 0
        <if test="id != null and id != ''">
            and v.id != #{id}
        </if>
    </select>

    <!-- 根据内部编号查询 -->
    <select id="findByInterNo" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        stmu.support_protocol supportProtocol,
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        <where>
            v.inter_no=#{interNo} and v.is_delete = 0
        </where>
    </select>

     <!-- 根据运营内部编号查询 -->
    <select id="findByOperInterNo" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        <where>
            v.oper_inter_no=#{operInterNo} and v.is_delete = 0
        </where>
    </select>

    <!-- 根据终端编号查询 -->
    <select id="findByTermId" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        <where>
            v.term_id = #{termId}
        </where>
    </select>

    <!-- 增加 -->
    <insert id="insert" parameterType="java.util.HashMap">
        insert into sys_vehicle (id,vin,uuid,license_type,license_plate,inter_no,veh_model_id,
          color,color_nick_name,term_id,stage,stage_change_date,manu_unit_id,produce_batch,quality_years,
          veh_certificate_number,produce_date,factory_date,sell_date,sell_price,sell_for_field,
          sell_pri_veh_owner_id,sell_pub_unit_id,sell_city_id,sell_4s_unit_id,sell_seller_id,
          sell_secure_date,sell_first_check_date,sell_invoice_no,sell_invoice_date,sell_invoice_img_id,
          sell_license_no,sell_license_reg_date,sell_license_grant_date,sell_license_img_id,
          is_selled,oper_inter_no,oper_use_for,oper_use_type,oper_veh_owner_id,oper_unit_id,
          oper_license_city_id,oper_area_id,oper_time,oper_support_owner_id,oper_save_city_id,
          oper_save_address,oper_chg_city_id,oper_chg_address,is_opered,subsidy_apply_status,
          susidy_apply_count,create_time,create_by,license_plate_color,secondary_mtc_status,
          secondary_mtc_time,forced_scrap_date,initial_registration_date,annual_inspection_status,
          annual_inspection_date,annual_inspection_period,maintenance_period)
        values
          (#{id},#{vin},#{uuid},#{licenseType},#{licensePlate},#{interNo},#{vehModelId},
          #{color},#{colorNickName},#{termId},#{stage},#{stageChangeDate},#{manuUnitId},#{produceBatch},#{qualityYears},
          #{vehCertificateNumber},#{produceDate},#{factoryDate},#{sellDate},#{sellPrice},#{sellForField},
          #{sellPriVehOwnerId},#{sellPubUnitId},#{sellCityId},#{sell4sUnitId},#{sellSellerId},
          #{sellSecureDate},#{sellFirstCheckDate},#{sellInvoiceNo},#{sellInvoiceDate},#{sellInvoiceImgId},
          #{sellLicenseNo},#{sellLicenseRegDate},#{sellLicenseGrantDate},#{sellLicenseImgId},
          #{isSelled},#{operInterNo},#{operUseFor},#{operUseType},#{operVehOwnerId},#{operUnitId},
          #{operLicenseCityId},#{operAreaId},#{operTime},#{operSupportOwnerId},#{operSaveCityId},
          #{operSaveAddress},#{operChgCityId},#{operChgAddress},#{isOpered},#{subsidyApplyStatus},
          #{susidyApplyCount},#{createTime},#{createBy},#{licensePlateColor},#{secondaryMtcStatus},#{secondaryMtcTime},
          #{forcedScrapDate},#{initialRegistrationDate},#{annualInspectionStatus},#{annualInspectionDate},#{annualInspectionPeriod},#{maintenancePeriod})
    </insert>

    <!-- 更新车辆信息 -->
    <update id="update" parameterType="java.util.HashMap">
        update sys_vehicle v set
        vin=#{vin},
        inter_no=#{interNo},
        veh_model_id=#{vehModelId},
        color=#{color},
        color_nick_name=#{colorNickName},
        term_id=#{termId},stage=#{stage},stage_change_date=#{stageChangeDate},
        manu_unit_id=#{manuUnitId},
        produce_batch=#{produceBatch},
        quality_years=#{qualityYears},
        veh_certificate_number=#{vehCertificateNumber},
        produce_date=#{produceDate},
        factory_date=#{factoryDate},
        update_time=#{updateTime},
        update_by=#{updateBy}
        <where>
            id = #{id}
        </where>

    </update>

    <!-- 删除 -->
    <update id="delete"  parameterType="java.util.HashMap">
        update sys_vehicle v set
        is_delete = 1, term_id = null
        <!-- , vin = CONCAT(vin,'(已删除)') -->
        <where>
            id = #{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </update>

    <!-- 分页查询 -->
    <select id="pagerModel" resultMap="tailResults" parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        <where>
            v.is_delete = 0
            <if test="authSQL != null">
             <include refid="authSQL"/>
            </if>
            <!-- 车型id -->
            <if test="vehModelId != null and vehModelId != ''">
                AND v.veh_model_id = #{vehModelId}
            </if>
            <!-- 终端id -->
            <if test="termId != null and termId != ''">
                AND v.term_id = #{termId}
            </if>
        </where>
    </select>

    <!-- 车辆列表分页条件查询 -->
    <select id="findPagerModel" resultMap="tailResults" parameterType="java.util.HashMap" resultOrdered="true">
        SELECT
            sv.id,sv.uuid, sv.vin, sv.license_plate, sv.inter_no, sv.manu_unit_id, sv.produce_batch, sv.oper_license_city_id, sv.color,
            sv.stage, sv.stage_change_date, sv.update_by, sv.create_time, sv.factory_date, sv.produce_date, sv.term_id,
            sv.sell_for_field,sv.quality_years, sv.veh_certificate_number, sv.oper_unit_id, sv.veh_model_id, sv.oper_use_for,sv.create_by,
            svm.veh_model_name, svm.config_name, svm.veh_unit_id, svm.rule_id, svm.battery_package_count,
            svo.owner_name, svo.tel_phone,
            sell_unit.name sell_pub_unit_name, sell_unit.telephone sell_pub_unit_telephone,
            rule_type.name rule_type_name,
            svt.`name` AS veh_type_name, svt.attr_cls,
            svn.`name` AS veh_notice_name,
            svb.name AS veh_brand_name,
            svs.name as veh_series_name,
            su.`name` AS unit_name,
            stmu.iccid, stmu.serial_number AS term_serial_number,
            dr.name AS term_rule_name,
            stm.term_model_name ,
            area.name AS oper_license_city_name, sut.`name` AS oper_unit_name, saa.`name` AS oper_area_name, svm.power_mode AS powerMode, stmu.support_protocol, sim.msisd
        FROM sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        LEFT JOIN sys_veh_type svt ON svt.id = svn.veh_type_id
        LEFT JOIN sys_term_model_unit stmu ON stmu.id = sv.term_id
        LEFT JOIN dc_rule dr on  dr.id = stmu.support_protocol
        LEFT JOIN sys_term_model stm ON stm.id = stmu.sys_term_model_id
        LEFT JOIN sys_sim_management sim on stmu.iccid = sim.iccid
        LEFT JOIN sys_unit su ON su.id = stm.unit_id
        LEFT JOIN sys_veh_owner svo ON svo.id = sv.sell_pri_veh_owner_id
        left join sys_area area on area.id = sv.oper_license_city_id
        left join sys_unit sell_unit on sell_unit.id = sv.sell_pub_unit_id
        left join dc_rule_type rule_type on rule_type.id = svm.rule_id
        LEFT JOIN sys_unit sut ON sut.id = sv.oper_unit_id
        LEFT JOIN sys_area saa ON saa.id = sv.oper_area_id
        LEFT JOIN sys_vehicle_real_status svrs ON svrs.vehicle_id = sv.id
        <where>
            sv.is_delete = 0
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>

            <if test="importSearchValues != null and importSearchValues.size()>0">
                and sv.vin in
                <foreach collection="importSearchValues" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="uncheckedIds != null and uncheckedIds.size()>0">
                and sv.id not in
                <foreach collection="uncheckedIds" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <!-- 车辆型号汽车厂商 -->
            <if test="vehUnitId != null and vehUnitId != ''">
                AND svm.veh_unit_id = #{vehUnitId}
            </if>
            <!-- 车牌号模糊查询 -->
            <if test="licensePlate != null and licensePlate != ''">
                AND sv.license_plate LIKE CONCAT('%',#{licensePlate},'%')
            </if>
            <!-- 车牌号精确查询 -->
            <if test="licensePlateEq != null and licensePlateEq != ''">
                AND sv.license_plate = #{licensePlateEq}
            </if>
            <!-- vin码模糊查询 -->
            <if test="vin != null and vin != ''">
                AND sv.vin LIKE CONCAT('%',#{vin},'%')
            </if>
            <!-- vin码精确查询 -->
            <if test="vinEq != null and vinEq != ''">
                AND sv.vin = #{vinEq}
            </if>
            <!-- 内部编号 -->
            <if test="interNo != null and interNo != ''">
                AND sv.inter_no LIKE CONCAT('%',#{interNo},'%')
            </if>
            <if test="iccid != null and iccid != ''">
                AND stmu.iccid LIKE CONCAT('%',#{iccid},'%')
            </if>
            <if test="ownerName != null and ownerName != ''">
                AND svo.owner_name LIKE CONCAT('%',#{ownerName},'%')
            </if>
            <if test="telPhone != null and telPhone != ''">
                AND svo.tel_phone LIKE CONCAT('%',#{telPhone},'%')
            </if>
            <if test="manuUnitId != null and manuUnitId != ''">
                AND sv.manu_unit_id = #{manuUnitId}
            </if>
            <!-- 车型名称模糊查询 -->
            <if test="vehModelName != null and vehModelName != ''">
                AND svm.veh_model_name LIKE CONCAT('%',#{vehModelName},'%')
            </if>
            <!-- 车型id -->
            <if test="vehModelId != null and vehModelId != ''">
                AND sv.veh_model_id = #{vehModelId}
            </if>
            <if test="unitId != null and unitId != ''">
                AND stm.unit_id = #{unitId}
            </if>
            <!-- 品牌ID -->
            <if test="brandId != null and brandId != ''">
                AND svb.id = #{brandId}
            </if>
            <!-- 车型系列ID -->
            <if test="seriesId != null and seriesId != ''">
                AND svs.id = #{seriesId}
            </if>
            <!-- id集合 -->
            <if test="vehicleIds != null">
                AND sv.id IN
                <foreach collection="vehicleIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <!-- 过滤id -->
            <if test="excludeIds != null">
                AND sv.id NOT IN
                <foreach collection="excludeIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <!-- 车型id -->
            <if test="vehModelIds != null">
                AND svm.id IN
                <foreach collection="vehModelIds" item="modelId" open="(" separator="," close=")">
                    #{modelId}
                </foreach>
            </if>
            <!-- 上牌地区 -->
            <if test="operLicenseCityId != null and operLicenseCityId != ''">
                and area.path LIKE CONCAT('%/',#{operLicenseCityId},'/%')
            </if>
            <!-- 车辆运营单位id -->
            <if test="operUnitId != null and operUnitId != ''">
                AND sv.oper_unit_id = #{operUnitId}
            </if>
            <!-- 车辆运营单位名称 -->
            <if test="operUnitName != null and operUnitName != ''">
                AND sut.name LIKE CONCAT('%',#{operUnitName},'%')
            </if>
            <!-- 车辆种类id -->
            <if test="vehTypeId != null and vehTypeId != ''">
                AND svt.path LIKE CONCAT('%/',#{vehTypeId},'/%')
            </if>
            <!-- 终端型号 -->
            <if test="termModelName != null and termModelName != ''">
                AND stm.term_model_name LIKE CONCAT('%',#{termModelName},'%')
            </if>
            <!-- 通讯协议 -->
            <if test="ruleId != null and ruleId != ''">
                AND stmu.support_protocol = #{ruleId}
            </if>
            <!-- 动力方式 -->
            <if test="powerMode != null and powerMode != ''">
                AND svm.power_mode = #{powerMode}
            </if>
            <!-- 过滤某个转发平台的车辆 -->
            <if test="platformId != null and platformId != ''">
                AND sv.id not in (select fv.vehicle_id from dc_forward_vehicle fv where fv.platform_id = #{platformId})
            </if>
            <!-- 查询未新增运营信息的车辆 -->
            <if test="filterOpered != null and filterOpered != ''">
                AND (sv.is_opered = 0 or sv.is_opered is null)
            </if>
            <!-- 查询未新增销售信息的车辆 -->
            <if test="filterSelled != null and filterSelled != ''">
                AND (sv.is_selled = 0 or sv.is_selled is null)
            </if>
            <!-- 过滤msisd为空的的车辆 -->
            <if test="filterMsisd != null and filterMsisd != ''">
                AND sim.msisd is not null
            </if>
            <!-- 过滤iccid为空的的车辆 -->
            <if test="filterIccid != null and filterIccid != ''">
                AND stmu.iccid is not null
            </if>
            <!-- 车辆在线状态 -->
            <if test="onlineStatus != null and onlineStatus != ''">
                AND svrs.online_status = #{onlineStatus}
            </if>
            <!-- iccid中的电话号码 -->
            <if test="msisd != null and msisd != ''">
                AND sim.msisd = #{msisd}
            </if>
            <!-- 终端编号 -->
            <if test="termSerialNumber != null and termSerialNumber != ''">
                AND stmu.serial_number = #{termSerialNumber}
            </if>
        </where>
        order by sv.create_time desc
    </select>

    <select id="findPagerModelByBaseInfo" resultMap="tailResults" parameterType="java.util.HashMap">
        SELECT
        sv.id, sv.vin, sv.license_plate, sv.inter_no, sv.manu_unit_id, sv.produce_batch, sv.oper_license_city_id,
        sv.stage, sv.stage_change_date, sv.update_by, sv.create_time, sv.factory_date, sv.produce_date, sv.term_id,
        svm.veh_model_name AS veh_model_name, svm.config_name AS config_name,
        svt.`name` AS veh_type_name, svt.attr_cls AS attr_cls,
        svn.`name` AS veh_notice_name,
        svb.name AS veh_brand_name,
        svs.name as veh_series_name,
        su.`name` AS unit_name,
        stmu.iccid AS iccid,
        stm.term_model_name AS term_model_name,
        svo.owner_name AS owner_name, svo.tel_phone AS tel_phone
        FROM sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        LEFT JOIN sys_veh_type svt ON svt.id = svn.veh_type_id
        LEFT JOIN sys_term_model_unit stmu ON stmu.id = sv.term_id
        LEFT JOIN sys_term_model stm ON stm.id = stmu.sys_term_model_id
        LEFT JOIN sys_unit su ON su.id = stm.unit_id
        LEFT JOIN sys_veh_owner svo ON svo.id = sv.sell_pri_veh_owner_id
        <where>
            sv.is_delete = 0
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
            <if test="licensePlate != null and licensePlate != ''">
                AND sv.license_plate LIKE CONCAT('%',#{licensePlate},'%')
            </if>
            <if test="vin != null and vin != ''">
                AND sv.vin LIKE CONCAT('%',#{vin},'%')
            </if>
            <if test="interNo != null and interNo != ''">
                AND sv.inter_no LIKE CONCAT('%',#{interNo},'%')
            </if>
            <if test="iccid != null and iccid != ''">
                AND stmu.iccid LIKE CONCAT('%',#{iccid},'%')
            </if>
            <if test="importSearchValues != null and importSearchValues.size()>0">
                and sv.vin in
                <foreach collection="importSearchValues" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        order by sv.vin asc
    </select>

    <select id="findPagerModelByBaseInfoList" resultMap="tailResults" parameterType="java.util.HashMap">
        SELECT
        sv.id, sv.vin, sv.license_plate, sv.inter_no, sv.manu_unit_id, sv.produce_batch, sv.oper_license_city_id,
        sv.stage, sv.stage_change_date, sv.update_by, sv.create_time, sv.factory_date, sv.produce_date, sv.term_id,
        svm.veh_model_name AS veh_model_name, svm.config_name AS config_name,
        svt.`name` AS veh_type_name, svt.attr_cls AS attr_cls,
        svn.`name` AS veh_notice_name,
        svb.name AS veh_brand_name,
        svs.name as veh_series_name,
        su.`name` AS unit_name,
        stmu.iccid AS iccid,
        stm.term_model_name AS term_model_name,
        svo.owner_name AS owner_name, svo.tel_phone AS tel_phone
        FROM sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        LEFT JOIN sys_veh_type svt ON svt.id = svn.veh_type_id
        LEFT JOIN sys_term_model_unit stmu ON stmu.id = sv.term_id
        LEFT JOIN sys_term_model stm ON stm.id = stmu.sys_term_model_id
        LEFT JOIN sys_unit su ON su.id = stm.unit_id
        LEFT JOIN sys_veh_owner svo ON svo.id = sv.sell_pri_veh_owner_id
        <where>
            sv.is_delete = 0
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
                AND ((sv.license_plate IN
                <foreach collection="licensePlates" item="licensePlate" open="(" separator="," close=")">#{licensePlate}
                </foreach>)
                or (sv.vin IN
                <foreach collection="vins" item="vin" open="(" separator="," close=")">#{vin}
                </foreach>)
                or (sv.inter_no IN
                <foreach collection="interNos" item="interNo" open="(" separator="," close=")">#{interNo}
                </foreach>)
                or (stmu.iccid IN
                <foreach collection="iccids" item="iccid" open="(" separator="," close=")">#{iccid}
                </foreach>))
        </where>
        order by sv.vin asc
    </select>

    <!-- 更新车辆销售信息 -->
    <update id="updateSell" parameterType="java.util.HashMap">
        update sys_vehicle v set
            sell_date=#{sellDate},sell_price=#{sellPrice},sell_for_field=#{sellForField},
            sell_pri_veh_owner_id=#{sellPriVehOwnerId},sell_pub_unit_id=#{sellPubUnitId},
            sell_city_id=#{sellCityId},sell_4s_unit_id=#{sell4sUnitId},sell_seller_id=#{sellSellerId},
            sell_secure_date=#{sellSecureDate},sell_first_check_date=#{sellFirstCheckDate},
            sell_invoice_no=#{sellInvoiceNo},sell_invoice_date=#{sellInvoiceDate},
            stage=#{stage},stage_change_date=#{stageChangeDate},
            sell_invoice_img_id=#{sellInvoiceImgId}, is_selled=#{isSelled},
            update_time=#{updateTime},update_by=#{updateBy}
        WHERE id = #{id}
    </update>


    <!-- 车辆销售列表分页查询 -->
    <select id="findVehSellPager" resultMap="tailResults" parameterType="java.util.HashMap" resultOrdered="true">
        SELECT
            sv.id, sv.vin, sv.license_plate, sv.sell_date, sv.sell_price, sv.sell_for_field,
            sv.sell_invoice_no, sv.sell_invoice_date, sv.sell_invoice_img_id, sv.color, sv.oper_use_for,
            sv.sell_pri_veh_owner_id, sv.sell_pub_unit_id, sv.sell_city_id, sv.sell_seller_id,
            sv.sell_secure_date, sv.sell_first_check_date, sv.sell_license_no, sv.sell_license_reg_date,
            sv.sell_license_grant_date, sv.sell_license_img_id, sv.sell_4s_unit_id, sv.oper_unit_id, operunit.name as oper_owner_name,
            svt.`name` AS veh_type_name,
            svm.veh_model_name AS veh_model_name, svm.veh_unit_id,
            svo.owner_name AS owner_name, svo.address AS owner_address, svo.card_no,
            su.`name` AS sell_pub_unit_name, su.address AS sell_pub_unit_address, su.organization_code,
            sa.`name` AS sell_city_name,
            svb.name AS veh_brand_name,
            svs.name as veh_series_name
        FROM sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        LEFT JOIN sys_veh_type svt ON svt.id = svn.veh_type_id
        LEFT JOIN sys_veh_owner svo ON svo.id = sv.sell_pri_veh_owner_id
        LEFT JOIN sys_unit su ON su.id = sv.sell_pub_unit_id
        LEFT JOIN sys_area sa ON sa.id = sv.sell_city_id
        left join sys_unit operunit on operunit.id = sv.oper_unit_id
        WHERE sv.is_selled = 1 and sv.is_delete = 0
        <if test="authSQL != null">
            <include refid="authSQL"/>
        </if>
        <if test="importSearchValues != null and importSearchValues.size()>0">
            and sv.vin in
            <foreach collection="importSearchValues" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <!-- 车辆型号汽车厂商 -->
        <if test="vehUnitId != null and vehUnitId != ''">
            AND svm.veh_unit_id = #{vehUnitId}
        </if>
        <!--  VIN码 -->
        <if test="vin != null and vin != '' ">
            AND sv.vin LIKE CONCAT('%',#{vin},'%')
        </if>
        <!-- 车牌号 -->
        <if test="licensePlate != null and licensePlate != ''">
            AND sv.license_plate LIKE CONCAT('%',#{licensePlate},'%')
        </if>
        <!-- 车辆种类ID -->
        <if test="vehTypeId != null and vehTypeId != ''">
            AND svt.id = #{vehTypeId}
        </if>
        <!-- 车辆型号ID -->
        <if test="vehModelId != null and vehModelId != ''">
            AND svm.id = #{vehModelId}
        </if>
        <!-- 车辆厂商ID -->
        <if test="manuUnitId != null and manuUnitId != ''">
            AND sv.manu_unit_id = #{manuUnitId}
        </if>
        <!-- 购车领域 -->
        <if test="sellForField != null and sellForField != ''">
            AND sv.sell_for_field = #{sellForField}
        </if>
        <!-- 购车人id -->
        <if test="sellOwnerId != null and sellOwnerId != ''">
            and sv.sell_pri_veh_owner_id = #{sellOwnerId}
        </if>
        <!-- 购车人姓名 -->
        <if test="ownerName != null and ownerName != ''">
            AND svo.owner_name LIKE CONCAT('%',#{ownerName},'%')
        </if>
        <!-- 购车单位id -->
        <if test="sellPubUnitId != null and sellPubUnitId != ''">
            AND sv.sell_pub_unit_id = #{sellPubUnitId}
        </if>
        <!-- 购车单位名称 -->
        <if test="sellPubUnitName != null and sellPubUnitName != ''">
            AND su.`name` LIKE CONCAT('%',#{sellPubUnitName},'%')
        </if>
        <!-- 购车城市 -->
        <if test="sellCityId != null and sellCityId != ''">
            and sa.path LIKE CONCAT('%/',#{sellCityId},'/%')
        </if>
        <!-- 销售开始日期 -->
        <if test="beginTime != null and beginTime != ''">
            AND <![CDATA[ sv.sell_date >= #{beginTime}  ]]>
        </if>
        <!-- 销售结束日期 -->
        <if test="endTime != null and endTime != ''">
            AND <![CDATA[ sv.sell_date <= #{endTime} ]]>
        </if>
        <!-- 品牌ID -->
        <if test="brandId != null and brandId != ''">
            AND svb.id = #{brandId}
        </if>
        <!-- 车型系列ID -->
        <if test="seriesId != null and seriesId != ''">
            AND svs.id = #{seriesId}
        </if>
        <!-- id集合 -->
        <if test="vehicleIds != null">
            AND sv.id IN
            <foreach collection="vehicleIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        order by sv.create_time desc
    </select>


    <!-- 更新车辆运营使用信息 -->
    <update id="updateOper" parameterType="java.util.HashMap">
        update sys_vehicle v set
        license_type=#{licenseType},license_plate=#{licensePlate}, oper_inter_no=#{operInterNo},
        oper_use_for=#{operUseFor},oper_use_type=#{operUseType},oper_veh_owner_id=#{operVehOwnerId},
        oper_unit_id=#{operUnitId},oper_license_city_id=#{operLicenseCityId},
        oper_area_id=#{operAreaId},oper_time=#{operTime},oper_support_owner_id=#{operSupportOwnerId},
        oper_save_city_id=#{operSaveCityId},oper_save_address=#{operSaveAddress},
        oper_chg_city_id=#{operChgCityId},oper_chg_address=#{operChgAddress},
        stage=#{stage},stage_change_date=#{stageChangeDate},
        sell_license_no=#{sellLicenseNo},
        sell_license_reg_date=#{sellLicenseRegDate},
        sell_license_grant_date=#{sellLicenseGrantDate},
        sell_license_img_id=#{sellLicenseImgId},
        is_opered=#{isOpered}, update_time=#{updateTime},update_by=#{updateBy},
        license_plate_color=#{licensePlateColor},secondary_mtc_status=#{secondaryMtcStatus},
        secondary_mtc_time=#{secondaryMtcTime},forced_scrap_date=#{forcedScrapDate},
        initial_registration_date=#{initialRegistrationDate},annual_inspection_status=#{annualInspectionStatus},
        annual_inspection_date=#{annualInspectionDate},annual_inspection_period=#{annualInspectionPeriod},maintenance_period=#{maintenancePeriod}
        ,oper_license_time=#{operLicenseTime}
        where id = #{id}
        <if test="authSQL != null">
            <include refid="authSQL"/>
        </if>
    </update>

    <!-- 车辆运营列表 -->
    <select id="findVehOperPager" resultMap="tailResults" parameterType="java.util.HashMap">
        SELECT sv.id, sv.license_type, sv.license_plate, sv.vin, sv.oper_use_for, sv.oper_inter_no,
           sv.oper_use_type, sv.oper_veh_owner_id, sv.oper_area_id, sv.oper_time, sv.oper_support_owner_id,
           sv.oper_save_city_id, sv.oper_save_address, sv.oper_chg_city_id, sv.oper_chg_address,
           sv.sell_secure_date, sv.sell_first_check_date, sv.sell_license_no, sv.sell_license_reg_date,
           sv.sell_license_grant_date, sv.sell_license_img_id, sv.oper_license_city_id,
           svt.`name` AS veh_type_name,
           svm.veh_model_name AS veh_model_name,
           svo.owner_name AS oper_owner_name,
           svo.tel_phone AS oper_tel_phone,
           su.`name` AS oper_unit_name,
           su.contactor_name AS oper_contactor_name,
           su.contactor_phone AS oper_contactor_phone,
           sa.`name` AS oper_area_name,
           sop.owner_name AS oper_support_owner_name,
           sop.tel_phone AS oper_support_owner_phone,
           area.`name` AS oper_save_city_name,
           chg_area.`name` AS oper_chg_city_name,
           svb.name AS veh_brand_name,
           svs.name as veh_series_name,
           sv.annual_inspection_status,
           sv.annual_inspection_date,
           sv.annual_inspection_period,
           sv.maintenance_period,
           sv.license_plate_color,sv.initial_registration_date,sv.secondary_mtc_status,sv.secondary_mtc_time,sv.forced_scrap_date
           ,sv.oper_license_time, svm.power_mode AS powerMode
        FROM sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        LEFT JOIN sys_veh_type svt ON svt.id = svn.veh_type_id
        LEFT JOIN sys_veh_owner svo ON svo.id = sv.oper_veh_owner_id
        LEFT JOIN sys_unit su ON su.id = sv.oper_unit_id
        LEFT JOIN sys_area sa ON sa.id = sv.oper_area_id
        LEFT JOIN sys_owner_people sop ON sop.id = sv.oper_support_owner_id
        LEFT JOIN sys_area area ON area.id = sv.oper_save_city_id
        LEFT JOIN sys_area chg_area ON chg_area.id = sv.oper_chg_city_id
        LEFT JOIN sys_area li_area ON li_area.id = sv.oper_license_city_id
        where sv.is_opered = 1 and sv.is_delete = 0
        <if test="authSQL != null">
            <include refid="authSQL"/>
        </if>
        <if test="importSearchValues != null and importSearchValues.size()>0">
            and sv.vin in
            <foreach collection="importSearchValues" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <!--  VIN码 -->
        <if test="vin != null and vin != '' ">
            AND sv.vin LIKE CONCAT('%',#{vin},'%')
        </if>
        <!--  车牌号 -->
        <if test="licensePlate != null and licensePlate != '' ">
            AND sv.license_plate LIKE CONCAT('%',#{licensePlate},'%')
        </if>
        <!--  运营内部编号 -->
        <if test="operInterNo != null and operInterNo != '' ">
            AND sv.oper_inter_no LIKE CONCAT('%',#{operInterNo},'%')
        </if>
        <!-- 车辆种类ID -->
        <if test="vehTypeId != null and vehTypeId != ''">
            AND svt.path LIKE CONCAT('%/',#{vehTypeId},'/%')
        </if>
        <!-- 车辆型号ID -->
        <if test="vehModelId != null and vehModelId != ''">
            AND svm.id = #{vehModelId}
        </if>
        <!-- 运营单位id -->
        <if test="operUnitId != null and operUnitId != ''">
            AND sv.oper_unit_id = #{operUnitId}
        </if>
        <!-- 运营个人车主 -->
        <if test="operVehOwnerId != null and operVehOwnerId != ''">
            AND sv.oper_veh_owner_id = #{operVehOwnerId}
        </if>
        <!-- 车辆用途 -->
        <if test="operUseFor != null and operUseFor != ''">
            AND sv.oper_use_for = #{operUseFor}
        </if>
        <!-- 车辆运营性质 -->
        <if test="operUseType != null and operUseType != ''">
            AND sv.oper_use_type = #{operUseType}
        </if>
        <!--  售后负责人姓名 -->
        <if test="operSupportOwnerName != null and operSupportOwnerName != '' ">
            AND sop.owner_name LIKE CONCAT('%',#{operSupportOwnerName},'%')
        </if>
        <!--  售后负责人手机号 -->
        <if test="operSupportOwnerPhone != null and operSupportOwnerPhone != '' ">
            AND sop.tel_phone LIKE CONCAT('%',#{operSupportOwnerPhone},'%')
        </if>
        <!-- 运营区域 -->
        <if test="operAreaId != null and operAreaId != ''">
            AND sa.path LIKE CONCAT('%/',#{operAreaId},'/%')
        </if>
        <!-- 投运开始日期 -->
        <if test="beginTime != null and beginTime != ''">
            AND <![CDATA[ sv.oper_time >= #{beginTime}  ]]>
        </if>
        <!-- 投运结束日期 -->
        <if test="endTime != null and endTime != ''">
            AND <![CDATA[ sv.oper_time <= #{endTime} ]]>
        </if>
        <!-- 品牌ID -->
        <if test="brandId != null and brandId != ''">
            AND svb.id = #{brandId}
        </if>
        <!-- 车型系列ID -->
        <if test="seriesId != null and seriesId != ''">
            AND svs.id = #{seriesId}
        </if>
        <!-- 上牌城市 -->
        <if test="operLicenseCityId != null and operLicenseCityId != ''">
            AND li_area.path LIKE CONCAT('%/',#{operLicenseCityId},'/%')
        </if>

        <if test="annualInspectionDateEnd != null and annualInspectionDateEnd != ''">
            AND sv.annual_inspection_date != '' AND <![CDATA[ sv.annual_inspection_date <= #{annualInspectionDateEnd} ]]>
        </if>
        <!-- 动力方式 -->
        <if test="powerMode != null and powerMode != ''">
            AND svm.power_mode = #{powerMode}
        </if>

        order by sv.create_time desc
    </select>

    <select id="findUuidByVinAndLicense" resultType="java.lang.String">
        SELECT v.uuid
        FROM sys_vehicle v
        <where>
            v.is_delete = 0
            <if test="vin != null and vin != '' ">
                AND v.vin = #{vin}
            </if>
            <if test="licensePlate != null and licensePlate != '' ">
                AND v.license_plate = #{licensePlate}
            </if>
            <if test="interNo != null and interNo != '' ">
                AND v.inter_no = #{interNo}
            </if>
        </where>
    </select>

    <select id="findByVinAndLicenseAndInterNo" resultType="com.bitnei.cloud.sys.domain.Vehicle"
            parameterType="java.util.HashMap">
        select
        svn.veh_type_id as vehTypeId,
        vrs.onlined as onlined,
        stmu.iccid,
        stmu.support_protocol supportProtocol,
        svm.veh_model_name AS vehModelName,
        svm.rule_id ruleId,
        rt.name ruleTypeName,
        <include refid="moreColumns"/>
        from sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join dc_rule_type rt on rt.id = svm.rule_id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        <where>
            v.is_delete = 0
            <if test="vin != null and vin != '' ">
                AND v.vin = #{vin}
            </if>
            <if test="licensePlate != null and licensePlate != '' ">
                AND v.license_plate = #{licensePlate}
            </if>
            <if test="interNo != null and interNo != '' ">
                AND v.inter_no = #{interNo}
            </if>
        </where>
    </select>

    <select id="getByIds" resultMap="tailResults" parameterType="java.util.List">
        select
        svm.veh_model_name AS veh_model_name,
        svt.name AS veh_type_name,
        svn.name AS veh_notice_name,
        svn.notice_batch as veh_notice_batch,
        svn.recommend_batch as recommend_batch,
        svt.`name` AS veh_type_name,
        svn.`name` AS veh_notice_name,
        svt.name as veh_type_name,
        rule_type.name as rule_type_name,
        svo.owner_name AS owner_name,
        svo.address AS owner_address,
        su.`name` AS sell_pub_unit_name,
        su.address AS sell_pub_unit_address,
        sa.`name` AS sell_city_name,
        sop.owner_name AS oper_support_owner_name,
        sop.tel_phone AS oper_support_owner_phone,
        area.`name` AS oper_save_city_name,
        chg_area.`name` AS oper_chg_city_name,
        svow.owner_name AS oper_owner_name,
        svow.tel_phone AS oper_tel_phone,
        sut.`name` AS oper_unit_name,
        sut.contactor_name AS oper_contactor_name,
        sut.contactor_phone AS oper_contactor_phone,
        saa.`name` AS oper_area_name,
        svn.veh_type_id as vehTypeId,
        vrs.online_status as historyOnlineState,
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        left join sys_veh_model svm on v.veh_model_id = svm.id
        left join sys_veh_notice svn on svn.id = svm.notice_id
        LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
        LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
        left join sys_veh_type svt on svt.id = svn.veh_type_id
        left join dc_rule_type rule_type on rule_type.id = svm.rule_id
        LEFT JOIN sys_veh_owner svo ON svo.id = v.sell_pri_veh_owner_id
        LEFT JOIN sys_unit su ON su.id = v.sell_pub_unit_id
        LEFT JOIN sys_area sa ON sa.id = v.sell_city_id
        LEFT JOIN sys_owner_people sop ON sop.id = v.oper_support_owner_id
        LEFT JOIN sys_area area ON area.id = v.oper_save_city_id
        LEFT JOIN sys_area chg_area ON chg_area.id = v.oper_chg_city_id
        LEFT JOIN sys_veh_owner svow ON svow.id = v.oper_veh_owner_id
        LEFT JOIN sys_unit sut ON sut.id = v.oper_unit_id
        LEFT JOIN sys_area saa ON saa.id = v.oper_area_id
        left join sys_vehicle_real_status vrs on vrs.vehicle_id = v.id
        where v.id in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="findIdsAuthSql" resultType="java.lang.String">
        select v.id from sys_vehicle v where v.is_delete = 0
        <if test="value != null">
            and ${value}
        </if>
    </select>

    <!-- 根据iccid查询 -->
    <select id="findByIccId" resultType="com.bitnei.cloud.sys.domain.Vehicle"  parameterType="java.util.HashMap">
        select
        <include refid="moreColumns"/>
        from
        sys_vehicle v
        LEFT JOIN sys_term_model_unit stmu ON v.term_id = stmu.id
        <where>
            v.is_delete = 0 and stmu.iccid = #{iccid}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </select>



    <!-- 车辆换件、解绑 -->
    <update id="changeORUnBindParts" parameterType="java.util.HashMap">
        update sys_vehicle set term_id=#{termId}, veh_model_id=#{vehModelId}, update_time=#{updateTime}, update_by=#{updateBy}
        <where>
            id = #{id}
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
        </where>
    </update>

    <select id="vehicles" resultType="com.bitnei.cloud.sys.model.VehicleInfoModel">
        SELECT
            sv.id,
            sv.vin,
            sv.uuid AS vid,
            sv.license_plate,
            sv.inter_no,
            svm.id as veh_model_id,
            svm.veh_model_name,
            sv.oper_license_city_id,
            sv.oper_area_id,
            sv.oper_unit_id AS oper_unit_id,
            sv.oper_use_for,
            svn.id AS veh_notice_id,
            svn.`name` AS veh_notice_name,
            svm.veh_unit_id AS veh_unit_id,
            sv.create_time,
            sv.update_time,
            sct.who_can_see_me
        from sys_vehicle sv
        left join sys_veh_model svm on sv.veh_model_id = svm.id
        left join sys_veh_notice svn on svm.notice_id = svn.id
        left join sys_core_tag sct on (sct.table_name='sys_vehicle' and sct.id_value = sv.id)
        <where>
            sv.is_delete = 0
            <if test="vid != null and vid != ''">
                and sv.uuid = #{vid}
            </if>
            <if test="updateTime != null and updateTime != ''">
                and sv.update_time >= #{updateTime}
            </if>
        </where>

    </select>

    <select id="findForLk" resultMap="tailResults" parameterType="java.util.HashMap">
        SELECT
            sv.id,
            sv.vin,
            sv.license_plate,
            sv.inter_no,
            svm.veh_model_name,
            area.`NAME` AS oper_save_city_name
        FROM
            sys_vehicle sv
        LEFT JOIN sys_veh_model svm ON svm.id = sv.veh_model_id
        LEFT JOIN sys_area area ON area.id = sv.oper_license_city_id
        <where>
            sv.is_delete = 0
            <if test="authSQL != null">
                <include refid="authSQL"/>
            </if>
            <!-- 导入查询 -->
            <if test="importSearchValues != null and importSearchValues.size()>0">
                and sv.vin in
                <foreach collection="importSearchValues" index="index" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <!-- 车牌号精确查询 -->
            <if test="licensePlateEq != null and licensePlateEq != ''">
                AND sv.license_plate = #{licensePlateEq}
            </if>
            <!-- vin码精确查询 -->
            <if test="vinEq != null and vinEq != ''">
                AND sv.vin = #{vinEq}
            </if>
            <!-- 上牌地区 -->
            <if test="operLicenseCityId != null and operLicenseCityId != ''">
                and area.path LIKE CONCAT('%/',#{operLicenseCityId},'/%')
            </if>
            <!-- 未被分配车辆 -->
            <if test="faultNoticesCount != null and faultNoticesCount != '' and faultNoticesCount == 0">
                AND sv.id not in (select fnvl.vehicle_id from fault_notifier_vehicle_lk fnvl)
            </if>
            <!-- 已分配车辆 -->
            <if test="faultNoticesCount != null and faultNoticesCount != '' and faultNoticesCount &gt; 0">
                AND sv.id in (select fnvl.vehicle_id from fault_notifier_vehicle_lk fnvl)
            </if>
        </where>
        ORDER BY
            sv.create_time DESC
    </select>

    <!-- 根据车辆id查询芯片型号id -->
    <select id="getChipModelId" resultType="java.lang.String" parameterType="java.lang.String">
      select ec.chip_model_id from sys_vehicle v
      left join sys_term_model_unit tmu on v.term_id = tmu.id
      left join sys_encryption_chip ec on tmu.encryption_chip_id = ec.id
      where v.id = #{id}
      limit 1
    </select>

    <!-- 根据车辆id查询芯片id -->
    <select id="getChipId" resultType="java.lang.String" parameterType="java.lang.String">
        select encryption_chip_id
        from sys_vehicle v
        left join sys_term_model_unit tmu on v.term_id = tmu.id
        where v.id = #{id}
        limit 1
    </select>

    <!-- 根据vid 获取车辆内部编号车系和品牌 -->
    <select id="getInterNoByVid" resultMap="tailResults" parameterType="java.util.HashMap">
      SELECT
      v.id,
      v.uuid,
      v.inter_no,
      v.stage,
      svs.name AS veh_series_name,
      svb.name AS veh_brand_name,
      svrs.first_reg_time
      FROM sys_vehicle v
      LEFT JOIN sys_veh_model svm ON v.veh_model_id = svm.id
      LEFT JOIN sys_veh_notice svn ON svn.id = svm.notice_id
      LEFT JOIN sys_veh_brand svb ON svb.id = svn.brand_id
      LEFT JOIN sys_veh_series svs ON svs.id = svn.series_id
      LEFT JOIN sys_vehicle_real_status svrs ON svrs.vehicle_id = v.id
      WHERE v.uuid = #{vid} AND v.is_delete = 0
    </select>

    <select id="getSellInfo" resultType="java.util.HashMap" parameterType="string">
        select
        sv.sell_for_field,
        (case sv.sell_for_field when 1 then ow.owner_name else un.name end) sell_unit_or_vita,
        (case sv.sell_for_field when 1 then ow.tel_phone else un.telephone end) telephone
        from sys_vehicle sv
        left join sys_veh_owner ow on ow.id = sv.sell_pri_veh_owner_id
        left join sys_unit un on un.id = sv.sell_pub_unit_id
        where sv.id = #{id}
    </select>

    <update id="updateInspectStatusOutOfPeriodByVins" parameterType="java.util.List">
        update sys_vehicle v set v.annual_inspection_status = 3
        where v.vin in
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

</mapper>
